---
title: "Road accidents in New York"
author: "Luca Renz & Alvaro Cervan"
date: "30/08/2024"
output:
  html_document:
    toc: true
    df_print: paged
    theme: simplex

---

## Road accidents in New York
```{r setup, include=FALSE}
# Global options
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

This analysis aims to provide some insight about the car crashes in New York during the period of 2016 to 2022, focusing on some key factors such as vehicle type, hour and weather.

## Files
We count with 2 datasets, one cointaining the vehicle crashes and the second one about the weather of the location.

| Name                       | Rows     | Columns | Each row is a                          | Link                                                                                      |
|----------------------------|----------|---------|----------------------------------------|-------------------------------------------------------------------------------------------|
| **Vehicles dataset**       | 2.11M    | 29      | Motor Vehicle Collision                | [Vehicles dataset](https://data.cityofnewyork.us/Public-Safety/Motor-Vehicle-Collisions-Crashes/h9gi-nx95/data_preview) |
| **Weather dataset**        | 59,760   | 10      | Time stamp of Weather                  | [Weather dataset](https://www.kaggle.com/datasets/aadimator/nyc-weather-2016-to-2022?resource=download)                   |


## Data Preparation

In this step we will collect the data from the datasets, clean it and merge it to create a comprehensive dataset for analysis. 
Before merging, the data needs to be cleaned and enriched with additional information. Also shrinking the data to make it more manageable.

### Data Cleaning

The data cleaning process involves removing columns with high NA ratios, filtering out rows with missing values, and creating new columns to categorize the main causes of accidents. The data is then enriched with additional information such as the day of the week, month, quarter, year, and time of day.

Both datasets, specially `vehicles.csv`, contain a lot of rows which require a lot of memory and time to process. For this reason, we decide to eliminate rows with missing values and columns with high NA ratios, such as vehicle type 3, 4 and 5 as there are very few values in these columns (multiple vehicle accidents).

`Weather.xlsx` is a smaller dataset and the cleaning process is simpler, we just need to convert the time column to a correct format and rename some columns for better understanding.
Finally the data is then merged with the weather data to create a comprehensive dataset for analysis.

```{r Data Cleaning, eval=FALSE}
  ## packages
  library(lubridate) # used to round to the next hour
  library(dplyr)
  library(readxl)
  
  # VEHICLES DF - CLEANING
  vehicles_df <- read.csv("data/vehicles.csv", header=TRUE)
  
  ## columns to be removed due to high NaN ratio.
  columns_to_remove <- c(
    "CROSS.STREET.NAME",
    "ON.STREET.NAME",
    "OFF.STREET.NAME", 
    "CONTRIBUTING.FACTOR.VEHICLE.3",
    "CONTRIBUTING.FACTOR.VEHICLE.4", 
    "CONTRIBUTING.FACTOR.VEHICLE.5",
    "VEHICLE.TYPE.CODE.3",
    "VEHICLE.TYPE.CODE.4",
    "VEHICLE.TYPE.CODE.5",
    "COLLISION_ID"
  )
  
  min_cutoff_date <- as.Date("2016-01-01")
  max_cutoff_date <- as.Date("2022-01-01")
  
  ## Create broader categories for main causes
  conditions <- c("Aggressive Driving/Road Rage", "Pavement Slippery", "Following Too Closely", 
                  "Unspecified", "", "Passing Too Closely", "Driver Inexperience", 
                  "Passing or Lane Usage Improper", "Turning Improperly", "Unsafe Lane Changing", 
                  "Unsafe Speed", "Reaction to Uninvolved Vehicle", "Steering Failure", 
                  "Traffic Control Disregarded", "Other Vehicular", "Driver Inattention/Distraction", 
                  "Oversized Vehicle", "Pedestrian/Bicyclist/Other Pedestrian Error/Confusion", 
                  "Alcohol Involvement", "View Obstructed/Limited", "Failure to Yield Right-of-Way", 
                  "Illnes", "Lost Consciousness", "Brakes Defective", "Backing Unsafely", "Glare", 
                  "Passenger Distraction", "Fell Asleep", "Obstruction/Debris", "Tinted Windows", 
                  "Animals Action", "Drugs (illegal)", "Pavement Defective", "Other Lighting Defects", 
                  "Outside Car Distraction", "Driverless/Runaway Vehicle", "Tire Failure/Inadequate", 
                  "Fatigued/Drowsy", "Headlights Defective", "Accelerator Defective", 
                  "Failure to Keep Right", "Physical Disability", "Eating or Drinking", 
                  "Cell Phone (hands-free)", "Lane Marking Improper/Inadequate", 
                  "Cell Phone (hand-Held)", "Using On Board Navigation Device", "Other Electronic Device", 
                  "Traffic Control Device Improper/Non-Working", "Tow Hitch Defective", 
                  "Windshield Inadequate", "Vehicle Vandalism", "Shoulders Defective/Improper", 
                  "Prescription Medication", "Listening/Using Headphones", "Texting", "80", 
                  "Reaction to Other Uninvolved Vehicle", "1", "Drugs (Illegal)", "Illness", 
                  "Cell Phone (hand-held)")
  
  ## mapping for conditions
  categorize_condition <- function(condition) {
    if (grepl("Driving|Following|Passing|Inexperience|Improper|Changing|Speed|Distraction|Alcohol|Drugs|Phone|Eating|Fatigued|Sleeping|Pedestrian|Failure to Yield|Backing|Oversized", condition, ignore.case = TRUE)) {
      return("Human Error")
    } else if (grepl("Brakes|Steering|Tire|Headlights|Accelerator|Windshield|Tow Hitch|Defective|Failure", condition, ignore.case = TRUE)) {
      return("Mechanical Error")
    } else if (grepl("Pavement|Glare|Obstruction|Weather|Animals|View|Control|Shoulders", condition, ignore.case = TRUE)) {
      return("Environmental Conditions")
    } else if (grepl("Illness|Lost Consciousness|Physical Disability", condition, ignore.case = TRUE)) {
      return("Medical Condition")
    } else if (condition == "" || grepl("Unspecified|Other", condition, ignore.case = TRUE)) {
      return("Other/Unspecified")
    } else {
      return("Other/Unspecified")
    }
  }
  
  vehicles_df <- vehicles_df %>%
    mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%m/%d/%Y")) %>%  # Convert CRASH.DATE to Date format
    select(-all_of(columns_to_remove)) %>%
    filter(CRASH.DATE >= min_cutoff_date) %>%
    filter(CRASH.DATE < max_cutoff_date) %>%
    filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>%
    filter(LATITUDE != 0 | LONGITUDE != 0) %>%
    filter(!is.na(CRASH.TIME)) %>%
    ##create new column with broader category for accident
    mutate(Category = sapply(CONTRIBUTING.FACTOR.VEHICLE.1, categorize_condition)) %>%
    # Combine date and time into one string
    mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
    # Round down to the current hour
    mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour")) %>%
    # enriching datetime format to weekdays, month, quarter, year
    mutate(
      Weekday = wday(CRASH.DATETIME, label = TRUE, abbr = FALSE), 
      Month = month(CRASH.DATETIME, label = TRUE, abbr = FALSE),  
      Quarter = quarter(CRASH.DATETIME),                          
      Year = year(CRASH.DATETIME) ,
      Day = day(CRASH.DATETIME),
      Hour = hour(CRASH.DATETIME),  
      TimeOfDay = case_when(                      
        Hour >= 6 & Hour < 12  ~ "Morning",
        Hour >= 12 & Hour < 17 ~ "Afternoon",
        Hour >= 17 & Hour < 20 ~ "Late Afternoon",
        Hour >= 20 ~ "Night",
        Hour < 6 ~ "Early Morning",
        TRUE ~ "Unknown",
      )
    ) %>%
    filter(!is.na(CRASH.TIME)) %>%
    mutate(IS.DEADLY.ACCIDENT = (NUMBER.OF.PERSONS.KILLED + NUMBER.OF.PEDESTRIANS.KILLED + NUMBER.OF.CYCLIST.KILLED + NUMBER.OF.MOTORIST.KILLED) > 0,
           IS.INJURED.ACCIDENT = (NUMBER.OF.PERSONS.INJURED + NUMBER.OF.PEDESTRIANS.INJURED + NUMBER.OF.CYCLIST.INJURED + NUMBER.OF.MOTORIST.INJURED) > 0)
  
  # WEATHER DF - CLEANING
  weather_df <- read_excel("data/weather.xlsx")
  weather_df <- weather_df %>%
    rename("temperature_celsius" = "temperature_2m (Â°C)", "winddirection_10m_degrees" = "winddirection_10m (Â°)") %>%
    mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M")) %>% # Convert the TIME column to correct format
    filter(!is.na(time)) %>% #filter rows where there is no time 
    filter(rowSums(is.na(.)) / ncol(weather_df) < 0.8) # Filter rows where 80% or more columns are NaN/Na
  
  # MERGING DATAFRAMES
  merged_df <- left_join(vehicles_df, weather_df, by = c("CRASH.DATETIME" = "time"))
  
  write.csv(merged_df,"merged_all_years.csv")
  
  split_datasets <- split(merged_df, merged_df$Year)
  
  # Save each year to a separate file
  lapply(names(split_datasets), function(year) {
    filename <- paste0("merged_data_", year, ".csv")
    write.csv(split_datasets[[year]], file = filename, row.names = FALSE)
  })


```

The result is:
```{r Merged Dataframe Size, eval=FALSE}
merged_df <- read.csv("data/merged_all_years.csv", header = TRUE)
str(merged_df)
```

| Name            | Rows     | Columns | Each row is a                          |
|-----------------|----------|---------|----------------------------------------|
| **Merged dataset** | 1M | 40      | Combination of vehicle and weather data |

After merging the data, we will save each year to a separate file to make it easier to analyze the data by year. 
We will perform both analyses on the full dataset and on years separately.

```{r Save Data by Year, eval=FALSE}
# Save each year to a separate file
lapply(names(split_datasets), function(year) {
  filename <- paste0("data/merged_data_", year, ".csv")
  write.csv(split_datasets[[year]], file = filename, row.names = FALSE)
})

```

## Analysis

### Total Accidents in New York
```{r total_accidents}
# Loading necessary libraries
library(ggplot2)
library(dplyr)

# Load the data from a CSV file
data <- read.csv("data/merged_all_years.csv", header = TRUE)

# Convert the CRASH.DATE into a Date object
data$CRASH.DATE <- as.Date(data$CRASH.DATE, "%d/%m/%Y")

# Aggregating data by Year
yearly_accidents <- data %>%
  group_by(Year) %>%
  summarise(Total_Accidents = n(), .groups = 'drop')

# Plotting the data
ggplot(yearly_accidents, aes(x = Year, y = Total_Accidents, fill = Year)) +
  geom_bar(stat = "identity") +  # Set a single color for the bars
  labs(title = "Total Accidents per Year",
       x = "Year",
       y = "Number of Accidents") + theme_minimal() + theme(legend.position = "none")

```

In this graph we can see the total number of accidents per year in New York from 2016 to 2022. 
The number of accidents seems to be decreasing over the years, which is a positive trend.

It is important to note that we cannot draw any conclusions from this graph alone, as there may be other factors influencing the number of accidents, such as the pandemic of COVID-19 and the lockdowns that occurred in 2020 and 2021, which could have reduced the number vehicles on the road and therefore the number of accidents.

### Correlation between Total Accidents and Total Rainfall per Month
```{r Correlation}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(lubridate)
library(readxl)

# Load the data
accident_data <- read.csv("data/merged_data_2021.csv", header = TRUE)
weather_data <- read_excel("data/weather_2021.xlsx")

# Step 1: Extract Date and Hour from the 'time' column in the weather data
weather_data <- weather_data %>%
  mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M"))

# Step 2: Convert CRASH.DATE in accident_data to Date type
accident_data <- accident_data %>%
  mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%Y-%m-%d"))

# Step 3: Match accidents with corresponding hourly rainfall data
accident_data <- accident_data %>%
  mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
  mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour"))

accidents_with_rainfall <- left_join(accident_data, weather_data, by = c("CRASH.DATETIME" = "time"))

# Step 4: Categorize rainfall into meaningful bins
accidents_with_rainfall <- accidents_with_rainfall %>%
  mutate(Rainfall_Category = case_when(
    rain..mm. == 0 ~ "0 mm (No rain)",
    rain..mm. > 0 & rain..mm. <= 4 ~ "1 mm - 4 mm (Light rain)",
    rain..mm. > 4 & rain..mm. <= 7 ~ ">4 mm - 7 mm (Moderate rain)",
    rain..mm. > 7 ~ ">7 mm (Heavy rain)"
  ))

# Step 5: Group data by Month and Rainfall Category
accidents_by_month_rainfall <- accidents_with_rainfall %>%
  mutate(Month = month(CRASH.DATETIME, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Accidents = n(), .groups = 'drop')

# Step 6: Calculate total rainfall per month
total_rainfall_per_month <- weather_data %>%
  mutate(Month = month(time, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Rainfall = sum(`rain (mm)`))

# Step 7: Merge the accident data with the rainfall data
correlation_data <- left_join(accidents_by_month_rainfall, total_rainfall_per_month, by = "Month")

# Step 8: Calculate the correlation coefficient
correlation_coefficient <- cor(correlation_data$Total_Accidents, correlation_data$Total_Rainfall)
print(paste("Correlation coefficient:", round(correlation_coefficient, 2)))

# Step 9: Plot the correlation with labels
ggplot(correlation_data, aes(x = Total_Rainfall, y = Total_Accidents)) +
  geom_point(aes(color = Month), size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  geom_text(aes(label = Month), vjust = -1, hjust = 1, size = 4) +
  labs(title = paste("Correlation between Total Accidents and Total Rainfall per Month\nCorrelation coefficient:", round(correlation_coefficient, 2)),
       x = "Total Rainfall (mm)",
       y = "Total Accidents") +
  theme_minimal() +
  theme(legend.position = "right") +
  scale_color_discrete(name = "Month")

```

This graph shows the correlation between the total number of accidents and the total rainfall per month in New York in 2021. The result of `0.59` indicates a moderate positive correlation between the two variables, suggesting that higher rainfall may lead to more accidents.

### Monthly Accidents and Rainfall

```{r Monthly Accidents and Rainfall, fig.cap="Monthly Number of Accidents by Rainfall Category with Monthly Rainfall"}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(lubridate)
library(readxl)

# Load the data
accident_data <- read.csv("data/merged_data_2021.csv", header = TRUE)
weather_data <- read_excel("data/weather_2021.xlsx")

# Step 1: Extract Date and Hour from the 'time' column in the weather data
weather_data <- weather_data %>%
  mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M"))

# Step 2: Convert CRASH.DATE in accident_data to Date type
accident_data <- accident_data %>%
  mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%Y-%m-%d"))

# Step 3: Match accidents with corresponding hourly rainfall data
accident_data <- accident_data %>%
  mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
  mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour"))

accidents_with_rainfall <- left_join(accident_data, weather_data, by = c("CRASH.DATETIME" = "time"))

# Step 4: Categorize rainfall into meaningful bins
accidents_with_rainfall <- accidents_with_rainfall %>%
  mutate(Rainfall_Category = case_when(
    rain..mm. == 0 ~ "0 mm (No rain)",
    rain..mm. > 0 & rain..mm. <= 4 ~ "1 mm - 4 mm (Light rain)",
    rain..mm. > 4 & rain..mm. <= 7 ~ ">4 mm - 7 mm (Moderate rain)",
    rain..mm. > 7 ~ ">7 mm (Heavy rain)"
  ))

# Step 5: Group data by Month and Rainfall Category
accidents_by_month_rainfall <- accidents_with_rainfall %>%
  mutate(Month = month(CRASH.DATETIME, label = TRUE)) %>%
  group_by(Month, Rainfall_Category) %>%
  summarise(Total_Accidents = n(), .groups = 'drop') %>%
  filter(!is.na(Rainfall_Category))  # Drop NA values

# Step 6: Calculate the total number of accidents per month across all categories
total_accidents_per_month <- accidents_by_month_rainfall %>%
  group_by(Month) %>%
  summarise(Total_Accidents_Month = sum(Total_Accidents))

# Step 7: Calculate total rainfall per month
total_rainfall_per_month <- weather_data %>%
  mutate(Month = month(time, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Rainfall = sum(`rain (mm)`))

# Step 8: Plot the data with dots for each category and a line for the total accidents
ggplot() +
  # Add dots for each category with transparency
  geom_point(data = accidents_by_month_rainfall, aes(x = Month, y = Total_Accidents, color = Rainfall_Category), size = 3, alpha = 0.3) +
  # Add a line for the total number of accidents per month
  geom_line(data = total_accidents_per_month, aes(x = Month, y = Total_Accidents_Month, group = 1), color = "black", size = 1) +
  # Add a secondary bar plot for total rainfall per month with a secondary y-axis
  geom_bar(data = total_rainfall_per_month, aes(x = Month, y = Total_Rainfall * 50), stat = "identity", fill = "blue", alpha = 0.3) +
  scale_y_continuous(
    name = "Number of Accidents",
    sec.axis = sec_axis(~./50, name = "Total Rainfall (mm)")
  ) +
  labs(title = "Monthly Number of Accidents by Rainfall Category with Monthly Rainfall",
       x = "Month") +
  theme_minimal() +
  theme(legend.position = "right")
```

This graph shows the monthly number of accidents in New York in 2021, categorized by rainfall intensity.
The black line represents the total number of accidents per month, while the blue bars represent the total rainfall per month on a secondary y-axis. The dots represent the number of accidents in each rainfall category. 

It can be appreciated that the number of accidents tends to increase with higher rainfall, especially in the "1 mm - 4 mm (Light rain)" and ">4 mm - 7 mm (Moderate rain)" categories.

At the same time, the majority of accidents occur in no rain conditions, which could be due simply to the fact that most of the time there is no rain in New York. Hence, ithout the a total amount of vehicles on the road, it is difficult to draw conclusions from this data alone.

```{r Accidents with Injuries or Deaths}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(fmsb)  # For radar chart

# Load your accident data
accident_data <- read.csv("data/merged_data_2021.csv")

# Filter for accidents with injuries
injured_accidents <- accident_data %>%
  filter(IS.INJURED.ACCIDENT == TRUE) %>%
  group_by(Weekday) %>%
  summarise(Accidents = n())

# Filter for accidents with deaths
deadly_accidents <- accident_data %>%
  filter(IS.DEADLY.ACCIDENT == TRUE) %>%
  group_by(Weekday) %>%
  summarise(Accidents = n())

# Filter for accidents with no injuries or deaths
no_injury_or_death_accidents <- accident_data %>%
  filter(IS.INJURED.ACCIDENT == FALSE & IS.DEADLY.ACCIDENT == FALSE) %>%
  group_by(Weekday) %>%
  summarise(Accidents = n())

# Ensure the weekday order is correct (Monday to Sunday)
injured_accidents$Weekday <- factor(injured_accidents$Weekday, 
                                    levels = c("Monday", "Tuesday", "Wednesday", 
                                               "Thursday", "Friday", "Saturday", "Sunday"))

deadly_accidents$Weekday <- factor(deadly_accidents$Weekday, 
                                   levels = c("Monday", "Tuesday", "Wednesday", 
                                              "Thursday", "Friday", "Saturday", "Sunday"))

no_injury_or_death_accidents$Weekday <- factor(no_injury_or_death_accidents$Weekday, 
                                               levels = c("Monday", "Tuesday", "Wednesday", 
                                                          "Thursday", "Friday", "Saturday", "Sunday"))

# Apply log transformation
injured_accidents$LogAccidents <- log1p(injured_accidents$Accidents)
deadly_accidents$LogAccidents <- log1p(deadly_accidents$Accidents)
no_injury_or_death_accidents$LogAccidents <- log1p(no_injury_or_death_accidents$Accidents)

# Reorder the data frame based on the correct weekday order
injured_accidents <- injured_accidents %>%
  arrange(Weekday)

deadly_accidents <- deadly_accidents %>%
  arrange(Weekday)

no_injury_or_death_accidents <- no_injury_or_death_accidents %>%
  arrange(Weekday)

# Prepare data for the radar chart (Injured)
radar_data_injured <- as.data.frame(t(injured_accidents$LogAccidents))
colnames(radar_data_injured) <- injured_accidents$Weekday
radar_data_injured <- rbind(rep(max(injured_accidents$LogAccidents), 7), # Maximum value for scaling
                            rep(min(injured_accidents$LogAccidents), 7), # Minimum value for scaling
                            radar_data_injured)

# Prepare data for the radar chart (Deadly)
radar_data_deadly <- as.data.frame(t(deadly_accidents$LogAccidents))
colnames(radar_data_deadly) <- deadly_accidents$Weekday
radar_data_deadly <- rbind(rep(max(deadly_accidents$LogAccidents), 7), # Maximum value for scaling
                           rep(min(deadly_accidents$LogAccidents), 7), # Minimum value for scaling
                           radar_data_deadly)

# Prepare data for the radar chart (No Injuries or Deaths)
radar_data_no_injury_or_death <- as.data.frame(t(no_injury_or_death_accidents$LogAccidents))
colnames(radar_data_no_injury_or_death) <- no_injury_or_death_accidents$Weekday
radar_data_no_injury_or_death <- rbind(rep(max(no_injury_or_death_accidents$LogAccidents), 7), # Maximum value for scaling
                                       rep(min(no_injury_or_death_accidents$LogAccidents), 7), # Minimum value for scaling
                                       radar_data_no_injury_or_death)

# Set up the plotting area to display three plots side by side
par(mfrow = c(1, 3))  # Set up a 1x3 plotting area
par(oma = c(0, 0, 4, 0))  # Set outer margins to make space for the main title

# Plot the radar chart for Injured Accidents
radarchart(radar_data_injured, axistype = 1,
           pcol = "blue", pfcol = scales::alpha("blue", 0.5), plwd = 2,
           cglcol = "grey", cglty = 1, axislabcol = "transparent",
           caxislabels = NA,  # Remove gray numbers
           cglwd = 0.8,
           vlcex = 0.8)
title(main = "with Injuries")

# Plot the radar chart for Deadly Accidents
radarchart(radar_data_deadly, axistype = 1,
           pcol = "red", pfcol = scales::alpha("red", 0.5), plwd = 2,
           cglcol = "grey", cglty = 1, axislabcol = "transparent",
           caxislabels = NA,  # Remove gray numbers
           cglwd = 0.8,
           vlcex = 0.8)
title(main = "with Deaths")

# Plot the radar chart for No Injuries or Deaths
radarchart(radar_data_no_injury_or_death, axistype = 1,
           pcol = "green", pfcol = scales::alpha("green", 0.5), plwd = 2,
           cglcol = "grey", cglty = 1, axislabcol = "transparent",
           caxislabels = NA,  # Remove gray numbers
           cglwd = 0.8,
           vlcex = 0.8)
title(main = "without Injuries or Deaths")

# Add a big title to the entire plot
mtext("Accidents per Weekday", outer = TRUE, cex = 2, font = 2)

```


```{r Heatmap Deadly and Injured Accidents}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Assuming `merged_df` is your prepared data from the previous steps
accidents_df <- read.csv("data/merged_data_2021.csv", header=TRUE)
# Filter for the relevant days and reorder factors
filtered_df <- accidents_df %>%
  filter(Weekday %in% c("Thursday", "Friday", "Saturday")) %>%
  mutate(TimeOfDay = factor(TimeOfDay, levels = c("Early Morning", "Morning", "Afternoon", "Late Afternoon", "Evening", "Night")),
         Weekday = factor(Weekday, levels = c("Saturday", "Friday", "Thursday")))

# Aggregate data by TimeOfDay and Weekday
agg_df <- filtered_df %>%
  group_by(Weekday, TimeOfDay) %>%
  summarise(Accidents = n()) %>%
  ungroup()

# Plotting the data
ggplot(agg_df, aes(x = TimeOfDay, y = Weekday, fill = Accidents)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red") +
  labs(title = "Deadly and Injured Accidents by Time of Day and Weekday (Thu-Sat)",
       x = "Time of Day", y = "Weekday (reversed order)", fill = "Number of Accidents") +
  theme_minimal()

```

## Chapter of Choice (Esquisse (Web Server App))
### If you like Tableau, you will love Esquisse

Esquisse is a package that allows you to create interactive plots and dashboards in R. 
It is similar to Tableau in that it provides a user-friendly interface for creating visualizations without writing code.

To use Esquisse, you need to install the package and then load it in your R script. 
After loading the package, you can launch the web app by calling the `esquisser()` function with your data as an argument.
That will open a web browser with the Esquisse interface, where you can create plots interactively by dragging and dropping variables.
Esquisse works with the `plotly` package to create interactive plots.

```{r Esquisse, eval=FALSE }
library(esquisse)
library(plotly)
options(shiny.maxRequestSize=300*1024^2) # Increase the maximum request size for Shiny apps
esquisser(data) # Opens the web app in the Viewer pane or in the browser with the data loaded
```

![Esquisse](resources\esquisse.png)

At the botom left of the pane, in the options tab, you can select to make the plots with `plotly` to make them interactive.
Once active, you can hover over the plots to see the data points and values or click on the legend to filter the data.

![Esquisse Options](resources\esquisse_plotly.png)

## Interactive Map of Accidents in New York

In this section, we will create an interactive map of accidents in New York using the `plotly` package.
The map will show the density of accidents based on latitude and longitude coordinates, with color indicating the density of accidents in each area.
It will be an interactive map that allows you to zoom in and out and hover over data points to see more information.

In the first view, it can look like that the whole New York is yellow, but if you zoom in, you will see the density of accidents in each area. This is to be expected and is due to the high number of inhabitants and accidents in New York.

It is interesting to see that the accidents are concentrated in certain areas, such as Manhattan and Brooklyn, which are more densely populated and have more traffic. Also, we can see a trend that horizontal roads (East-West) have more accidents than vertical roads (North-South).

Also, as expected, the accidents are more concentrated in main roads and highways, where the traffic is heavier, until a bridge is reached. In the map, we can see that virtually all bridges are free of accidents, which is a good sign for traffic safety.

```{r}
accidents <- read.csv("data/merged_data_2021.csv")
library(plotly)

# filter latitude and longitude equal to 0
accidents <- accidents[accidents$LATITUDE != 0 & accidents$LONGITUDE != 0,]

fig <- accidents 
fig <- fig %>%
  plot_ly(
    type = 'densitymapbox',
    lat = ~LATITUDE,
    lon = ~LONGITUDE,
    coloraxis = 'coloraxis',
    alpha = 0.6,
    alpha_stroke = 0.3,
    radius = 4) 
fig <- fig %>%
  layout(
    mapbox = list(
      style="open-street-map",
      center= list(lat=40.7128, lon=-74.0060),  # Coordinates for New York
      zoom = 8.5),  # Adjust zoom level as needed
    coloraxis = list(colorscale = 'Viridis'))

fig
```