---
title: "Road accidents in New York"
author: "Luca Renz & Alvaro Cervan"
date: "30/08/2024"
output:
  html_document:
    toc: true
    df_print: paged

---

## Road accidents in New York
```{r setup, include=FALSE}
# Global options
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Data Preparation

### Packages
```{r Packages}
## packages

#install.packages("lubridate")
library(lubridate) # used to round to the next hour

#install.packages("dplyr")
library(dplyr)

#install.packages("readxl")
library(readxl)
```

### Data Cleaning
```{r Data Cleaning, eval=FALSE}
  # VEHICLES DF - CLEANING
  vehicles_df <- read.csv("data/vehicles.csv", header=TRUE)
  
  ## columns to be removed due to high NA ratio.
  columns_to_remove <- c(
    "CROSS.STREET.NAME",
    "ON.STREET.NAME",
    "OFF.STREET.NAME", 
    "CONTRIBUTING.FACTOR.VEHICLE.3",
    "CONTRIBUTING.FACTOR.VEHICLE.4", 
    "CONTRIBUTING.FACTOR.VEHICLE.5",
    "VEHICLE.TYPE.CODE.3",
    "VEHICLE.TYPE.CODE.4",
    "VEHICLE.TYPE.CODE.5",
    "COLLISION_ID"
  )
  ## Cutoff dates to discard NA values
  min_cutoff_date <- as.Date("2016-01-01")
  max_cutoff_date <- as.Date("2022-01-01")
  
  ## Create broader categories for main causes
  conditions <- c("Aggressive Driving/Road Rage", "Pavement Slippery", "Following Too Closely", 
                  "Unspecified", "", "Passing Too Closely", "Driver Inexperience", 
                  "Passing or Lane Usage Improper", "Turning Improperly", "Unsafe Lane Changing", 
                  "Unsafe Speed", "Reaction to Uninvolved Vehicle", "Steering Failure", 
                  "Traffic Control Disregarded", "Other Vehicular", "Driver Inattention/Distraction", 
                  "Oversized Vehicle", "Pedestrian/Bicyclist/Other Pedestrian Error/Confusion", 
                  "Alcohol Involvement", "View Obstructed/Limited", "Failure to Yield Right-of-Way", 
                  "Illnes", "Lost Consciousness", "Brakes Defective", "Backing Unsafely", "Glare", 
                  "Passenger Distraction", "Fell Asleep", "Obstruction/Debris", "Tinted Windows", 
                  "Animals Action", "Drugs (illegal)", "Pavement Defective", "Other Lighting Defects", 
                  "Outside Car Distraction", "Driverless/Runaway Vehicle", "Tire Failure/Inadequate", 
                  "Fatigued/Drowsy", "Headlights Defective", "Accelerator Defective", 
                  "Failure to Keep Right", "Physical Disability", "Eating or Drinking", 
                  "Cell Phone (hands-free)", "Lane Marking Improper/Inadequate", 
                  "Cell Phone (hand-Held)", "Using On Board Navigation Device", "Other Electronic Device", 
                  "Traffic Control Device Improper/Non-Working", "Tow Hitch Defective", 
                  "Windshield Inadequate", "Vehicle Vandalism", "Shoulders Defective/Improper", 
                  "Prescription Medication", "Listening/Using Headphones", "Texting", "80", 
                  "Reaction to Other Uninvolved Vehicle", "1", "Drugs (Illegal)", "Illness", 
                  "Cell Phone (hand-held)")
  
  ## mapping for conditions
  categorize_condition <- function(condition) {
    if (grepl("Driving|Following|Passing|Inexperience|Improper|Changing|Speed|Distraction|Alcohol|Drugs|Phone|Eating|Fatigued|Sleeping|Pedestrian|Failure to Yield|Backing|Oversized", condition, ignore.case = TRUE)) {
      return("Human Error")
    } else if (grepl("Brakes|Steering|Tire|Headlights|Accelerator|Windshield|Tow Hitch|Defective|Failure", condition, ignore.case = TRUE)) {
      return("Mechanical Error")
    } else if (grepl("Pavement|Glare|Obstruction|Weather|Animals|View|Control|Shoulders", condition, ignore.case = TRUE)) {
      return("Environmental Conditions")
    } else if (grepl("Illness|Lost Consciousness|Physical Disability", condition, ignore.case = TRUE)) {
      return("Medical Condition")
    } else if (condition == "" || grepl("Unspecified|Other", condition, ignore.case = TRUE)) {
      return("Other/Unspecified")
    } else {
      return("Other/Unspecified")
    }
  }
  
  vehicles_df <- vehicles_df %>%
    mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%m/%d/%Y")) %>%  # Convert CRASH.DATE to Date format
    select(-all_of(columns_to_remove)) %>%
    filter(CRASH.DATE >= min_cutoff_date) %>%
    filter(CRASH.DATE < max_cutoff_date) %>%
    filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>%
    filter(!is.na(CRASH.TIME)) %>%
    ##create new column with broader category for accident
    mutate(Category = sapply(CONTRIBUTING.FACTOR.VEHICLE.1, categorize_condition)) %>%
    # Combine date and time into one string
    mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
    # Round down to the current hour
    mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour")) %>%
    # enriching datetime format to weekdays, month, quarter, year
    mutate(
      Weekday = wday(CRASH.DATETIME, label = TRUE, abbr = FALSE), 
      Month = month(CRASH.DATETIME, label = TRUE, abbr = FALSE),  
      Quarter = quarter(CRASH.DATETIME),                          
      Year = year(CRASH.DATETIME) ,
      Day = day(CRASH.DATETIME),
      Hour = hour(CRASH.DATETIME),  
      TimeOfDay = case_when(                      
        Hour >= 6 & Hour < 12  ~ "Morning",
        Hour >= 12 & Hour < 17 ~ "Afternoon",
        Hour >= 17 & Hour < 21 ~ "Evening",
        Hour >= 21 ~ "Night",
        Hour < 6 ~ "Night",
        TRUE ~ "Unknown",
      )
    ) %>%
    filter(!is.na(CRASH.TIME)) %>%
    mutate(IS.DEADLY.ACCIDENT = (NUMBER.OF.PERSONS.KILLED + NUMBER.OF.PEDESTRIANS.KILLED + NUMBER.OF.CYCLIST.KILLED + NUMBER.OF.MOTORIST.KILLED) > 0,
           IS.INJURED.ACCIDENT = (NUMBER.OF.PERSONS.INJURED + NUMBER.OF.PEDESTRIANS.INJURED + NUMBER.OF.CYCLIST.INJURED + NUMBER.OF.MOTORIST.INJURED) > 0)
  
  # WEATHER DF - CLEANING
  weather_df <- read_excel("data/weather.xlsx")
  weather_df <- weather_df %>%
    rename("temperature_celsius" = "temperature_2m (Â°C)", "winddirection_10m_degrees" = "winddirection_10m (Â°)") %>%
    mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M")) %>% # Convert the TIME column to correct format
    filter(!is.na(time)) %>% #filter rows where there is no time 
    filter(rowSums(is.na(.)) / ncol(weather_df) < 0.8) # Filter rows where 80% or more columns are NaN/Na
```

### Merging Dataframes
```{r Merging Dataframes, eval=FALSE}
# MERGING DATAFRAMES
merged_df <- left_join(vehicles_df, weather_df, by = c("CRASH.DATETIME" = "time"))

write.csv(merged_df,"data/merged_all_years.csv")

split_datasets <- split(merged_df, merged_df$Year)

# Save each year to a separate file
lapply(names(split_datasets), function(year) {
  filename <- paste0("data/merged_data_", year, ".csv")
  write.csv(split_datasets[[year]], file = filename, row.names = FALSE)
})

```

### Total Accidents in New York
```{r total_accidents}
# Loading necessary libraries
library(ggplot2)
library(dplyr)

# Load the data from a CSV file
data <- read.csv("data/merged_all_years.csv", header = TRUE)

# Convert the CRASH.DATE into a Date object
data$CRASH.DATE <- as.Date(data$CRASH.DATE, "%d/%m/%Y")

# Aggregating data by Year
yearly_accidents <- data %>%
  group_by(Year) %>%
  summarise(Total_Accidents = n(), .groups = 'drop')

# Plotting the data
ggplot(yearly_accidents, aes(x = Year, y = Total_Accidents, fill = Year)) +
  geom_bar(stat = "identity") +  # Set a single color for the bars
  labs(title = "Total Accidents per Year",
       x = "Year",
       y = "Number of Accidents") + theme_minimal() + theme(legend.position = "none")

```

```{r Correlation}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(lubridate)
library(readxl)

# Load the data
accident_data <- read.csv("data/merged_data_2021.csv", header = TRUE)
weather_data <- read_excel("data/weather_2021.xlsx")

# Step 1: Extract Date and Hour from the 'time' column in the weather data
weather_data <- weather_data %>%
  mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M"))

# Step 2: Convert CRASH.DATE in accident_data to Date type
accident_data <- accident_data %>%
  mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%Y-%m-%d"))

# Step 3: Match accidents with corresponding hourly rainfall data
accident_data <- accident_data %>%
  mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
  mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour"))

accidents_with_rainfall <- left_join(accident_data, weather_data, by = c("CRASH.DATETIME" = "time"))

# Step 4: Categorize rainfall into meaningful bins
accidents_with_rainfall <- accidents_with_rainfall %>%
  mutate(Rainfall_Category = case_when(
    rain..mm. == 0 ~ "0 mm (No rain)",
    rain..mm. > 0 & rain..mm. <= 4 ~ "1 mm - 4 mm (Light rain)",
    rain..mm. > 4 & rain..mm. <= 7 ~ ">4 mm - 7 mm (Moderate rain)",
    rain..mm. > 7 ~ ">7 mm (Heavy rain)"
  ))

# Step 5: Group data by Month and Rainfall Category
accidents_by_month_rainfall <- accidents_with_rainfall %>%
  mutate(Month = month(CRASH.DATETIME, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Accidents = n(), .groups = 'drop')

# Step 6: Calculate total rainfall per month
total_rainfall_per_month <- weather_data %>%
  mutate(Month = month(time, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Rainfall = sum(`rain (mm)`))

# Step 7: Merge the accident data with the rainfall data
correlation_data <- left_join(accidents_by_month_rainfall, total_rainfall_per_month, by = "Month")

# Step 8: Calculate the correlation coefficient
correlation_coefficient <- cor(correlation_data$Total_Accidents, correlation_data$Total_Rainfall)
print(paste("Correlation coefficient:", round(correlation_coefficient, 2)))

# Step 9: Plot the correlation with labels
ggplot(correlation_data, aes(x = Total_Rainfall, y = Total_Accidents)) +
  geom_point(aes(color = Month), size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  geom_text(aes(label = Month), vjust = -1, hjust = 1, size = 4) +
  labs(title = paste("Correlation between Total Accidents and Total Rainfall per Month\nCorrelation coefficient:", round(correlation_coefficient, 2)),
       x = "Total Rainfall (mm)",
       y = "Total Accidents") +
  theme_minimal() +
  theme(legend.position = "right") +
  scale_color_discrete(name = "Month")

```

```{r Monthly Accidents and Rainfall}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(lubridate)
library(readxl)

# Load the data
accident_data <- read.csv("data/merged_data_2021.csv", header = TRUE)
weather_data <- read_excel("data/weather_2021.xlsx")

# Step 1: Extract Date and Hour from the 'time' column in the weather data
weather_data <- weather_data %>%
  mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M"))

# Step 2: Convert CRASH.DATE in accident_data to Date type
accident_data <- accident_data %>%
  mutate(CRASH.DATE = as.Date(CRASH.DATE, format = "%Y-%m-%d"))

# Step 3: Match accidents with corresponding hourly rainfall data
accident_data <- accident_data %>%
  mutate(CRASH.DATETIME = as.POSIXct(paste(CRASH.DATE, CRASH.TIME), format = "%Y-%m-%d %H:%M")) %>%
  mutate(CRASH.DATETIME = floor_date(CRASH.DATETIME, "hour"))

accidents_with_rainfall <- left_join(accident_data, weather_data, by = c("CRASH.DATETIME" = "time"))

# Step 4: Categorize rainfall into meaningful bins
accidents_with_rainfall <- accidents_with_rainfall %>%
  mutate(Rainfall_Category = case_when(
    rain..mm. == 0 ~ "0 mm (No rain)",
    rain..mm. > 0 & rain..mm. <= 4 ~ "1 mm - 4 mm (Light rain)",
    rain..mm. > 4 & rain..mm. <= 7 ~ ">4 mm - 7 mm (Moderate rain)",
    rain..mm. > 7 ~ ">7 mm (Heavy rain)"
  ))

# Step 5: Group data by Month and Rainfall Category
accidents_by_month_rainfall <- accidents_with_rainfall %>%
  mutate(Month = month(CRASH.DATETIME, label = TRUE)) %>%
  group_by(Month, Rainfall_Category) %>%
  summarise(Total_Accidents = n(), .groups = 'drop') %>%
  filter(!is.na(Rainfall_Category))  # Drop NA values

# Step 6: Calculate the total number of accidents per month across all categories
total_accidents_per_month <- accidents_by_month_rainfall %>%
  group_by(Month) %>%
  summarise(Total_Accidents_Month = sum(Total_Accidents))

# Step 7: Calculate total rainfall per month
total_rainfall_per_month <- weather_data %>%
  mutate(Month = month(time, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(Total_Rainfall = sum(`rain (mm)`))

# Step 8: Plot the data with dots for each category and a line for the total accidents
ggplot() +
  # Add dots for each category with transparency
  geom_point(data = accidents_by_month_rainfall, aes(x = Month, y = Total_Accidents, color = Rainfall_Category), size = 3, alpha = 0.3) +
  # Add a line for the total number of accidents per month
  geom_line(data = total_accidents_per_month, aes(x = Month, y = Total_Accidents_Month, group = 1), color = "black", size = 1) +
  # Add a secondary bar plot for total rainfall per month with a secondary y-axis
  geom_bar(data = total_rainfall_per_month, aes(x = Month, y = Total_Rainfall * 50), stat = "identity", fill = "blue", alpha = 0.3) +
  scale_y_continuous(
    name = "Number of Accidents",
    sec.axis = sec_axis(~./50, name = "Total Rainfall (mm)")
  ) +
  labs(title = "Monthly Number of Accidents by Rainfall Category with Monthly Rainfall",
       x = "Month") +
  theme_minimal() +
  theme(legend.position = "right")
```
```{r Shiny}
# Load necessary libraries
library(shiny)
library(ggplot2)
library(dplyr)
library(lubridate)

# Load the data
accident_data <- read.csv("data/merged_data_2021.csv", header = TRUE)
accident_data$CRASH.DATE <- as.Date(accident_data$CRASH.DATE)
min_date <- min(accident_data$CRASH.DATE, na.rm = TRUE)
max_date <- max(accident_data$CRASH.DATE, na.rm = TRUE)

# Define UI for the Shiny app
ui <- fluidPage(
  titlePanel("Accident Data Filter"),
  sidebarLayout(
    sidebarPanel(
      dateRangeInput("date_range", "Select Date Range:",
                     start = min_date,
                     end = max_date,
                     min = min_date,
                     max = max_date),
      selectInput("weekday", "Select Weekday(s):", 
                  choices = unique(accident_data$Weekday),
                  selected = c("Monday", "Wednesday", "Friday"),
                  multiple = TRUE),
      checkboxInput("is_deadly", "Accidents with Death(s)", value = FALSE),
      checkboxInput("is_injured", "Accidents with injured people", value = FALSE),
      actionButton("filter", "Apply Filters")
    ),
    
    mainPanel(
      plotOutput("accident_plot")
    )
  )
)
# Define server logic for the Shiny app
server <- function(input, output) {
  
  filtered_data <- reactive({
    data <- accident_data
    
    # Extract start and end dates from the input
    start_date <- input$date_range[1]
    end_date <- input$date_range[2]
    
    # Filter by the date range
    data <- data %>% filter(CRASH.DATE >= start_date & CRASH.DATE <= end_date)
    
    # Filter by weekdays
    data <- data %>% filter(Weekday %in% input$weekday)
    
    # Filter by deadly accidents
    if (input$is_deadly) {
      data <- data %>% filter(IS.DEADLY.ACCIDENT == TRUE)
    }
    
    # Filter by injured accidents
    if (input$is_injured) {
      data <- data %>% filter(IS.INJURED.ACCIDENT == TRUE)
    }
    
    return(data)
  })
  
  output$accident_plot <- renderPlot({
    data <- filtered_data()
    
    # Summarize the data to get the count of accidents per weekday
    data_summary <- data %>% 
      group_by(Weekday) %>% 
      summarise(Number_of_Accidents = n())
    
    # Plot the number of accidents by weekday
    ggplot(data_summary, aes(x = Weekday, y = Number_of_Accidents, fill = Weekday)) +
      geom_bar(stat = "identity") +
      labs(title = "Number of Accidents by Weekday",
           x = "Weekday",
           y = "Number of Accidents") +
      theme_minimal()
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

```{r Accidents with Injuries or Deaths}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(fmsb)  # For radar chart

# Load your accident data
accident_data <- read.csv("data/merged_data_2021.csv")

# Filter for accidents with injuries or deaths
filtered_accidents <- accident_data %>%
  filter(IS.INJURED.ACCIDENT == TRUE | IS.DEADLY.ACCIDENT == TRUE)

# Count the number of accidents per weekday
accidents_by_weekday <- filtered_accidents %>%
  group_by(Weekday) %>%
  summarise(Accidents = n())

# Ensure the weekday order is correct (Monday to Sunday)
accidents_by_weekday$Weekday <- factor(accidents_by_weekday$Weekday, 
                                       levels = c("Monday", "Tuesday", "Wednesday", 
                                                  "Thursday", "Friday", "Saturday", "Sunday"))

# Apply log transformation
accidents_by_weekday$LogAccidents <- log1p(accidents_by_weekday$Accidents)

# Reorder the data frame based on the correct weekday order
accidents_by_weekday <- accidents_by_weekday %>%
  arrange(Weekday)

# Prepare data for the radar chart
radar_data <- as.data.frame(t(accidents_by_weekday$LogAccidents))
colnames(radar_data) <- accidents_by_weekday$Weekday
radar_data <- rbind(rep(max(accidents_by_weekday$LogAccidents), 7), # Maximum value for scaling
                    rep(min(accidents_by_weekday$LogAccidents), 7), # Minimum value for scaling
                    radar_data)

# Plot the radar chart with the correct weekday order and without gray numbers
radarchart(radar_data, axistype = 1,
           pcol = "red", pfcol = scales::alpha("red", 0.5), plwd = 2,
           cglcol = "grey", cglty = 1, axislabcol = "transparent",
           caxislabels = NA,  # Remove gray numbers
           cglwd = 0.8,
           vlcex = 0.8)

# Add a title
title(main = "Accidents with Injuries or Deaths per Weekday")
```

## Chapter of Choice (Esquisse (Web Server App))

```{r Esquisse, eval=FALSE }
library(esquisse)
library(plotly)

esquisser(data) # Opens the web app in the Viewer pane or in the browser with the data loaded
```